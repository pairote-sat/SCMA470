# Tutorials 

## Tutorial 1

1.  Using the method of moments, calculate the parameter values for the
    gamma, lognormal and Pareto distributions for which
    $$\mathrm{E}[X] = 500 \quad  \text{and} \quad  \mathrm{Var}[X] = 100^2.$$
**Answer:** 

a. gamma: $\tilde{\alpha} = 25$, $\tilde{\lambda} = 0.05.$

b. lognormal: $\tilde{\mu} = 6.194998$, $\tilde{\sigma} = 0.1980422.$ 

c. the MME cannot apply for the Pareto distribution. For the given values of $$\mathrm{E}[X] = 500 \quad  \text{and} \quad  \mathrm{Var}[X] = 100^2$$, the obtained values of $\tilde{\alpha}$ and  $\tilde{\lambda}$ from the method of moments are negative. Note that if we fix $s = 100^2$ and vary $\bar{x}$ within the interval $[90,110]$, the plot of $\bar{x}$ against $\tilde{\alpha}$ is shown below. Notice that when $\bar{x} = 100$, $\tilde{\alpha}$ tends to infinity.

<script src=https://cdn.datacamp.com/datacamp-light-latest.min.js></script>

```{r , tut = FALSE, echo = TRUE}
xbar <-90:110
s <- 100
# MME
alpha_tilde <- 2*s^2/xbar^2 * 1/(s^2/xbar^2 - 1)
lambda_tilde <- xbar*(alpha_tilde -1)
plot(xbar,alpha_tilde, xlab = expression(bar(x)), ylab = expression(alpha))

```


2.  Show that if $X \sim \text{Exp}(\lambda)$, then the random variable
    $X-w$ conditional on $X > w$ has the same distribution as $X$, i.e.
    $$X \sim \text{Exp}(\lambda)\Rightarrow  X - w | X > w \sim \text{Exp}(\lambda).$$

**Solution:**
Let $W = Z|Z>0$ be a random variable representing the amount of a
non-zero payment by the reinsurer on a reinsurance claim. The
distribution and density of $W$ can be calculated as follows: for
$x > 0$, 
$$
\begin{aligned}
     \Pr[W \le x ] &= \Pr[Z \le x | Z >0] \\
            &= \Pr[X - M \le x | X > M] \\
            &= \frac{\Pr[M < X \le x + M]}{\Pr[X > M]}\\
            &= \frac{F_X(x+M) - F_X(M)}{1-F_X(M)}.
\end{aligned}
$$

Given $X \sim \textrm{Exp}(\lambda)$, $F_X(x) = 1 - e^{-\lambda x}.$ Moreover,

$$
\begin{aligned}
\Pr[W \le x ]  &= \frac{F_X(x+M) - F_X(M)}{1-F_X(M)}  \\
&= \frac{  e^{-\lambda (M)} - e^{-\lambda (x+M)}}{e^{-\lambda (M)}} \\
&=  1 - e^{-\lambda x}.
\end{aligned}
$$
Hence, $W \sim \textrm{Exp}(\lambda)$.

3.  Derive an expression for the variance of the
    $\text{Pa}(\alpha, \lambda)$ distribution. (Hint: using the pdf)

**Solution:**
Recall that that for $X \sim \mathcal{Pa}(\alpha,\lambda)$, its density function is
$$ f_X(x) = \frac{\alpha \lambda^\alpha}{ (x + \lambda)^{\alpha + 1}}.$$
$$
\begin{aligned}
\mathrm{E}[X] &= \int_0^\infty x \frac{\alpha \lambda^\alpha}{ (x + \lambda)^{\alpha + 1}}\, dx  \quad \text{(using integration by part:} \quad u = x \text{ and } (\lambda + x)^{-(\alpha + 1)}dx =  dv)  \\
&= -\alpha \lambda^\alpha \left( \frac{x}{\alpha} (\lambda + x)^{-\alpha} \right)\bigg|_0^\infty + (\alpha \lambda^\alpha)(\frac{1}{\alpha})\int_0^\infty \frac{1}{(\lambda + x)^\alpha} \, dx
\end{aligned}
$$
Using the fact that for $X \sim \mathcal{Pa}(\alpha,\lambda)$, $\textrm{E}[X]$ exists when $\alpha > 1$, which will be assumed on the first term above. This assumption simplifies the above results as follows:

$$
\begin{aligned}
\mathrm{E}[X] &= 
 0 + \int_0^\infty \frac{\lambda^\alpha}{(\lambda + x)^\alpha} \, dx \\
 &= 
 \frac{\lambda}{\alpha - 1} \int_0^\infty \frac{(\alpha - 1)\lambda^{\alpha - 1}}{(\lambda + x)^\alpha} \, dx \\ 
 &= 
 \frac{\lambda}{\alpha - 1} \cdot 1.
\end{aligned}
$$
Note that the last integral integrate to 1 because the integrand is the density function of a Pareto distribution.

One can also show that 
$$ \mathrm{E}[X^2]  = \frac{2 \lambda^2}{(\alpha - 1)(\alpha - 2)}.$$ Therefore,
$$ \mathrm{Var}[X] = \mathrm{E}[X^2] - (\mathrm{E}[X])^2 = \frac{\alpha \lambda^2}{(\alpha - 1)^2(\alpha - 2)}.$$

4.  Show that the MLE (the maximum likelihood estimation) of $\lambda$
    for an $\text{Exp}(\lambda)$ distribution is the reciprocal of the
    sample mean, i.e. $\hat\lambda = 1/ \bar x$.
**Solution:**
Suppose we have a random sample $x = (x_1, x_2, \ldots, x_n)$ of $X \sim \text{Exp}(\lambda).$ We have
$$
\begin{aligned}
  L(\lambda) &= \Pi_{i=1}^n f(x_i, \lambda) = \Pi_{i=1}^n  \lambda e^{-\lambda x_i} = \lambda^n e^{-\lambda \sum x_i}. \\
  l(\lambda) &= \log( L(\lambda)) = n \log(\lambda) - \lambda \sum x_i
\end{aligned}
$$
The MLE can be obtained by maximise $l(\lambda)$ with respect to $\lambda$.
$$ \frac{d\, l(\lambda)}{d \lambda }  = \frac{n}{\lambda} - \sum x_i = 0. $$
Therefore, the MLE of $\lambda$ is $\hat{\lambda} = 1/\bar{x}.$

5.  Claims last year on a portfolio of policies of a risk had a
    lognormal distribution with parameter $\mu = 5$ and
    $\sigma^2 = 0.4$. It is estimated that all claims will increase by
    15% next year. Find the probability that a claim next year will
    exceed 1000.
**Solution:**
From $X \sim \mathcal{LN}(5,0.4)$, $\log X \sim \mathcal{N}(5,0.4)$. Claims in next year will increase by 15\%. We define $Y = (1+15\%) X = 1.15 X$. We also have
$$
\begin{aligned}
\Pr(Y > 1000) &=\Pr(1.15 X > 1000)  \\
&=\Pr(\log X > \log (1000/1.15)) \\
&=\Pr\left(Z > \frac{\log (1000/1.15)) - 5 }{\sqrt{0.4}}\right) \\
&=\Pr\left(Z > 2.7954\right) \\
&=1 - \Pr\left(Z \le 2.7954\right) \\
&= 1 -  0.9974082 = 0.002591777. \\
\end{aligned}
$$
I used `R` to obtain the required probability.

## Tutorial 2


1.  Claims occur on a general insurance portfolio independently and at
    random. Each claim is classified as being of "Type A" or "Type B".
    Type A claim amounts are distributed $\text{Pa}(3,400)$ and Type B
    claim amounts are distributed $\text{Pa}(4,1000)$. It is known that
    90% of all claims are of Type A.

    Let $X$ denote a claim chosen at random from the portfolio.

    1.  Calculate $\Pr(X > 1000).$

    2.  Calculate $\mathrm{E}[X]$ and $\mathrm{Var}[X]$.

    3.  Let $Y$ have a Pareto distribution
        with the same mean and variance as $X$. Calculate
        $\Pr(Y > 1000).$

    4.  Comment on the difference in the answers found in 1.1 and 1.2.

2.  An insurer covers an individual loss $X$ with excess of loss
    reinsurance with retention level $M$. Let $Y$ and $Z$ be random
    variables representing the amounts paid by the insurer and
    reinsurer, respectively, i.e. $X = Y + Z$. Show that
    $\mathrm{Cov}[Y,Z] \ge 0$ and deduce that
    $$\mathrm{Var}[X] \ge \mathrm{Var}[Y] +  \mathrm{Var}[Z].$$ Comment
    on the results obtained.

3.  Claim amounts from a general insurance portfolio are lognormally
    distributed with mean 200 and variance 2916. Excess of loss
    reinsurance with retenton level 250 is arranged. Calculate the
    probability that the reinsurer is involved in a claim.

4.  Show that if $X \sim \text{Pa}(\alpha, \lambda)$, then the random
    variable $X-d$ conditional on $X > d$ has a pareto distribution with
    parameters $\alpha$ and $\lambda + d$, i.e.
    $$X \sim \text{Pa}(\alpha, \lambda)\Rightarrow  X - d | X > d \sim \text{Pa}(\alpha,\lambda + d).$$

5.  Consider a portfolio of motor insurance policies. In the event of an
    accident, the cost of the repairs to a car has a Pareto distribution
    with parameters $\alpha$ and $\lambda$. A deductible of 100 is
    applied to all claims and a claim is always made if the cost of the
    repairs exceeds this amount. A sample of 100 claims has mean 200 and
    standard deviation 250.

    1.  Using the method of moments, estimate $\alpha$ and $\lambda$.

    2.  Estimate the proportion of accidents that do not result in a
        claim being made.

    3.  The insurance company arranges excess of loss reinsurance with
        another insurance company to reduce the mean amount it pays on a
        claim to 160. Calculate the retention limit needed to achieve
        this.


## Solutions to Tutorial 2


     

```{r tutorial2-1, echo = FALSE, }
# discrete random variable
x <- c(1,2) #1 = type A, 2 = type B
px <- c(0.9,0.1)

alpha <- c(3,4)
beta <- c(400,1000)

claim <- 1000

pclaim <- ppareto(claim, shape = alpha, scale = beta, lower.tail = FALSE)

ans1 <- px %*% pclaim 

EXtype <-  beta/(alpha - 1)

EX2type <- alpha*beta^2/((alpha-1)^2 * (alpha-2)   ) + EXtype^2

EX <- px %*% EXtype

EX2 <- px %*% EX2type


VX <- EX2 - (EX)^2 
SX <- sqrt(VX)

alpha_tilde <- 2*VX/EX^2 * 1/(VX/EX^2 - 1) #/tilde/alpha
beta_tilde <- EX*(alpha_tilde -1)

pYclaim <- ppareto(claim, shape = alpha_tilde, scale = beta_tilde, lower.tail = FALSE)


```        
        
**Solution:**

1. 
    1. $$\begin{aligned}
\Pr(X > `r claim`) &= \Pr(X > `r claim` | A) \Pr(A) + \Pr(X > `r claim` | B) \Pr(B) \\
&= \left(  \frac{ `r beta[1]` }{ `r claim` + `r beta[1]`} \right)^{`r alpha[1]`} (`r px[1]`) +  \left(  \frac{ `r beta[2]` }{ `r claim` + `r beta[2]`} \right)^{`r alpha[2]`} (`r px[2]`) \\
&= `r ans1`.
\end{aligned}$$
    
    2. Using the conditional expectation and conditional variance formulas, we have
    

$$\begin{aligned} 
\mathrm{E}[X|A] &= \frac{`r beta[1]` }{`r alpha[1]` - 1} = `r beta[1]/(alpha[1] - 1)`, \\
\mathrm{E}[X|B] &= \frac{`r beta[2]` }{`r alpha[2]` - 1} = `r beta[2]/(alpha[2] - 1)`.
\end{aligned} $$
    Hence, 
$$\begin{aligned} 
\mathrm{E}[X] &= \mathrm{E}[\mathrm{E}[X|\text{type}]] \\
&=  \Pr(A) \, \mathrm{E}[X|A]   + \Pr(B) \, \mathrm{E}[X|B]   \\
&= (`r px[1]`)(`r beta[1]/(alpha[1] - 1)`) + (`r px[2]`)(`r beta[2]/(alpha[2] - 1)`) \\
&= `r px[1] * beta[1]/(alpha[1] - 1)  +  px[2] * beta[2]/(alpha[2] - 1)`.
\end{aligned}
$$
  
    We also have
  $$\begin{aligned} 
\mathrm{E}[X^2|A] &= \mathrm{Var}[X|A] + (\mathrm{E}[X|A])^2 = \frac{(`r alpha[1]`) (`r beta[1]`)^2}{(`r alpha[1]` - 1)^2 (`r alpha[1]` - 2)} + (`r  beta[1]/(alpha[1] - 1)`)^2   =   `r EX2type[1]`,\\
\mathrm{E}[X^2|B] &= \mathrm{Var}[X|B] + (\mathrm{E}[X|B])^2 = \frac{(`r alpha[2]`) (`r beta[2]`)^2}{(`r alpha[2]` - 1)^2 (`r alpha[2]` - 2)} + (`r  beta[2]/(alpha[2] - 1)`)^2   =   `r EX2type[2]`. 
\end{aligned}
$$
    Therefore, 
$\mathrm{E}[X^2] = (`r px[1]`)(`r EX2type[1]`) + (`r px[2]`)(`r EX2type[2]`) = `r EX2`$,
and 
$\mathrm{Var}[X] = `r VX`$, \quad 
$\mathrm{SD}[X] = `r SX`$. 

    3. Using moment matching estimation, we have
$\tilde{\alpha} = `r alpha_tilde`$ and $\tilde{\beta} = `r beta_tilde`$. Therefore, $\Pr[Y > `r claim`] = `r pYclaim` < `r ans1`$.

    4. Failure to separate two types of claims leads to an underestimation of tail probability. This affects the determination of premiums, reinsurance, and security.  
    
2.  1. From $X = Y + Z$, where $Y = \min(X,M)$ and $Z = \max(0,X -M)$.
$$\begin{aligned}
\mathrm{Cov}(Y,Z) &= \mathrm{E}[YZ] - \mathrm{E}[Y]\mathrm{E}[Z] \\
&= \int_0^\infty \min(X,M) \max(0,X -M) f_X(x) \, dx - \mathrm{E}[Y]\mathrm{E}[Z] \\
&= M \int_M^\infty \max(0,X -M) f_X(x) \, dx - \mathrm{E}[Y]\mathrm{E}[Z] \\
&= M \mathrm{E}[Z] - \mathrm{E}[Y]\mathrm{E}[Z] \\
&= \mathrm{E}[Z](M  - \mathrm{E}[Y])  \ge 0. \\
\end{aligned}$$

Therefore, 

$$\mathrm{Var}[X] = \mathrm{Var}[Y + Z] = \mathrm{Var}[Y] + \mathrm{Var}[Z] + 2Cov(X,Y)   \ge \mathrm{Var}[Y] + \mathrm{Var}[Z].$$

Consequently, there is a reduction in the variability of the amount paid out by the direct insurer on claims.  
  
  
```{r tutorial3, echo = FALSE, }
EX <- 200
VX <- 2916

sigma_tilda <- sqrt(log(  VX/EX^2 +1  ))  # gives \tilde\sigma
mu_tilda <- log(EX) - sigma_tilda^2/2      # gives \tilde\mu

x <- 250

probx <- pnorm(log(x), mean = mu_tilda, sd = sigma_tilda, lower.tail = FALSE )
```
  
  
3. By the method of moments, the MMEs of the parameter $\mu$ and $\sigma$ can be found by matching $\mathrm{E}[X]$ to the sample mean and $\mathrm{Var}[X]$ to the sample variance:

$$\mathrm{E}[X] = \exp\left(\mu + \frac{1}{2} \sigma^2 \right) = `r EX` \text{ and } \mathrm{Var}[X] =\exp\left(2\mu +  \sigma^2 \right) (\exp(\sigma^2) - 1) = `r VX`.$$
We find that $\tilde{\mu} = `r mu_tilda`$  and $\tilde{\sigma} = `r sigma_tilda`$. Moreover,
$$ \Pr(X > `r x`) = P( Z > \frac{\ln(`r x`) - \tilde{\mu}}{\tilde{\sigma}}) = `r probx`,$$
where $Z \sim \mathcal{N}(0,1)$. We find that the reinsurer is involved in about `r round(100*probx,2)`\% of claims.
  
  
4. Given $X \sim \mathcal{Pa}(\alpha,\lambda)$, define $W = X- d | X > d$.  
$$\begin{aligned}
     \Pr[W \le x ] &= \Pr[Z \le x | Z >0] \\
            &= \Pr[X - d \le x | X > d] \\
            &= \frac{\Pr[d < X \le x + d]}{\Pr[X > d]}\\
            &= \frac{F_X(x+d) - F_X(d)}{1-F_X(d)} \\
            &= 1 - \left(  \frac{\lambda + d}{\lambda + x +  d} \right)^\alpha. \end{aligned}$$

Hence, $W \sim \mathcal{Pa}(\alpha, \lambda + d).$  
  
  

```{r tutorial5, echo = FALSE, }


EY <- 200
VY <- 250^2

d<-100

alpha_tilde <- 2*VY/EY^2 * 1/(VY/EY^2 - 1) #/tilde/alpha
beta_tilde <- EY*(alpha_tilde -1)

lambda_tilde <- beta_tilde - d

ans2  <- ppareto(d,shape=alpha_tilde,scale=beta_tilde)

pYclaim <- ppareto(claim, shape = alpha_tilde, scale = beta_tilde, lower.tail = FALSE)


EYI <- 160
M <- (lambda_tilde + d)/(1 - (alpha_tilde - 1)*EYI/(lambda_tilde + d))^{1/(alpha_tilde - 1)} - (lambda_tilde + d)

```         
  

5.      
    1. Let $X$ be the cost of repair and $Y$ be the cost of claims. Suppose that $X \sim \mathcal{Pa}(\alpha, \lambda)$. It follows that 
$$ Y = X - d | X > d, $$
where $d = 100$. Moreover, $Y \sim \mathcal{Pa}(\alpha, \lambda + d).$ It should be emphasised that the given information implies that
  $$ \mathrm{E}[Y] = 200, \quad \mathrm{Var}[Y] = 250^2.$$ 
Letting $\lambda + d  = \phi$ results in $Y \sim \mathcal{Pa}(\alpha,  \phi).$
  
By the mothod of moments, the MMEs of $\alpha$ and $\phi$ (and hence $\lambda$) are 
$\tilde{\alpha} = `r alpha_tilde`$, $\tilde{\phi} = `r beta_tilde`$ and 
$\tilde{\lambda} = \tilde{\phi} - d = `r lambda_tilde`$.
  


2. The proportion of accidents that do not result in a claim being made is 

$$\Pr(X < d) = 1 - \left(\frac{\tilde{\lambda}}{\tilde{\lambda} + d}\right)^\alpha = `r ans2`.$$

3. We know that claims before excess of loss reinsurance is  $Y \sim \mathcal{Pa}(\alpha,  \phi).$ With excess of loss reinsurance contract, the expected value of the amount paid out by the insurer is $\mathrm{E}[\min(Y,M)],$ which can be calculated as follows: 
  
  
$$\begin{aligned}
    \mathrm{E}[Y_I] &= \mathrm{E}[\min(Y,M)] \\
    &=  \mathrm{E}[Y] - \int_0^\infty y \cdot f_Y(y+M) \, dy  \\
    &=  \mathrm{E}[Y] - \int_0^\infty y \cdot \frac{\alpha \phi^\alpha}{(\phi + y + M)^{\alpha + 1}} \, dy \\
    &=  \mathrm{E}[Y] - \left(\frac{\phi}{\phi+M} \right)^\alpha\int_0^\infty y \cdot \frac{\alpha (\phi + M)^\alpha}{(\phi + y + M)^{\alpha + 1}} \, dy.
\end{aligned}$$  

The last integral defines the mean of the Pareto random variable with parameters $\alpha$ and $\phi + M$ and so equals to $\frac{\phi + M}{\alpha - 1}$. After simplifying, we have 
$$\begin{aligned}
    \mathrm{E}[Y_I] 
    &=  \mathrm{E}[Y] - \left(\frac{\phi}{\phi+M} \right)^\alpha \left(\frac{\phi + M}{\alpha - 1}\right) = \left(\frac{\lambda + d}{\alpha - 1} \right)\left(1 - \left( \frac{\lambda + d}{\lambda + d + M} \right)^{\alpha - 1}  \right).
\end{aligned}$$    
  
Substituting all the parameter values and $\mathrm{E}[Y_I] = 160$, we solve for $M$ which results in 
$$M = \frac{\tilde{\lambda} + d}{\left(1- \frac{(\tilde{\alpha} -1)\mathrm{E}[Y_I]}{(\tilde{\lambda} + d)}  \right)^{ \frac{1}{\tilde{\alpha} - 1}   }} - (\tilde{\lambda} + d )  =  `r round(M,4)`.$$


---
title: " **SCMA 470 : Risk Analysis and Credibility** **Tutorial 3**"
---

## Tutorial 3


1.  The aggregate claims $S$ have a compound Poisson random variable
    with Poisson parameter $\lambda = 20$ and claim amounts have a
    $\mathcal{G}(2,1)$ distribution. Find the coefficient of skewness of the
    aggregate claim amount $Sk[S]$.

2.  Suppose that $S_1$ and $S_2$ are independent compound Poisson random
    variables with Poisson parameters $\lambda_1 = 10$ and
    $\lambda_2 = 30$ and the claim sizes for $S_i$ are exponentially
    distributed with mean $\mu_i$ where $\mu_1 = 1$ and $\mu_2 = 2$,
    respectively. Find the distribution of the random sum
    $S = S_1 + S_2$.

3.  The number of claims in one time period has a negative binomial
    distribution $\mathcal{NB}(k, p)$ with $k = 1$ and claim sizes have an
    exponential distribution with mean $\mu$.

    1.  Use the moment generating formula to obtain the distribution of
        the aggregate claim amount $S$.

    2.  Find the mean and variance of the aggregate claims for this time
        period.

4.  A portfolio consists of 100 car insurance policies. 60% of the
    policies have a deductible of 10 and the remaining have a deductible
    of 0. The insurance policy pays the amount of damage in excess of
    the deductible subject to a maximum of 125 per accident. Assume that

    1.  The number of accident per year **per policy** has a Poisson
        distribution with mean 0.02; and

    2.  The amount of damage has the distribution:
        $$Pr(X = 50) = 1/3, Pr(X = 150) = 1/3, Pr(X = 200) = 1/3.$$

    Find the expected insurer's payout.

5.  The number of claims $N$ per a fixed time period has the following
    distribution:
    $$Pr(N = 0) = 0.5, Pr(N = 1) = 0.3, Pr(N = 2) = 0.1, \text{ and } Pr(N = 3) = 0.1.$$
    The loss distribution is uniformly distributed on the interval
    $(0,100)$. Assume that the number of claims and the amount of losses
    are mutually independent.

    1.  Find the mean and variance of the aggregate claims for this
        fixed time period.

    2.  Suppose that a policy deductible of 20 is in place. Find the
        expected insurer's payout.





## Solutions to Tutorial 3


```{r tutorial3-1, echo = FALSE, }
# Compound Poisson Distribution
# CP(lambda,FX)
# N ~ Poisson(lambad) = Poisson(10)
# X ~ Ga(alpha,beta)= Pa(2,1)

lambda <-20
alpha <- 2
beta <- 1


r <- c(1,2,3)
mr <- (1/beta^r)*(gamma(alpha + r)/gamma(alpha))


ES <- lambda*mr[1]
VS <- lambda*mr[2]
Sk <- (lambda * mr[3])/(lambda * mr[2])^(3/2)   
```

1. 
    1. The aggregate claims $S$ have a compound Poisson random variable, $S \sim \mathcal{CP}(\lambda, F_X)$ with $\lambda = 20$ and $X \sim \mathcal{G}(\alpha,\beta) = \mathcal{G}(2,1)$ distribution.
From $\mathrm{Sk}[S] = \frac{\lambda m_3}{(\lambda m_2)^{3/2}}$ with $m_r = \mathrm{E}[X^r]$, we also have

$$\mathrm{E}[X^r] = \frac{1}{\beta^r} \frac{\Gamma(\alpha + r)}{\Gamma(\alpha )}, \quad r > 0.$$

  Note that if $\alpha$ is an integer, then $\Gamma(\alpha) = (\alpha-1)!$.

  Substituting all the parameter values, we have
$\mathrm{E}[X^2] = `r mr[2]`$, $\mathrm{E}[X^3] = `r mr[3]`$ and $\mathrm{Sk}[S] = `r Sk`$.


2. $S_1 \sim \mathcal{CP}(\lambda, F_1)$ and $S_2 \sim \mathcal{CP}(\lambda, F_2)$ are independent compound Poisson random variables with claim sizes exponential distributions for $S_i$, $\text{Exp}(1/\mu_i)$ where $\mu_1 = 1$ and $\mu_2 = 2$.

    By the additivity of independent compound Poisson
distributions, the distribution of $S = S_1 + S_2$ is $\mathcal{CP}(\lambda, F_X)$, where
$$ F_X(x) = \frac{10}{40} F_1(x) + \frac{30}{40} F_2(x) = \frac{1}{4}(1 - e^{-x}) + \frac{3}{4} (1 - e^{-x/2}).$$
    It is the mixture of exponential distribution with mean 1 and 2.
  

  
3. 
    1. From $N \sim \mathcal{NB}(1, p)$ and $X \sim \text{Exp}(\mu)$, the moment generating functions of 
$N$ and $X$ are 
$$ M_N(t) = \frac{p}{1-q e^t}, \quad M_X(t) = \frac{1}{1 - \mu t},$$
    where $q = 1- p$.

    Therefore,
$$\begin{aligned}
M_S(t) &= M_N(\log(M_X(t))) \\
&=  \frac{p}{1-q M_X(t)} \\
&= p + q\frac{1}{1- \frac{\mu}{p}t}
\end{aligned}.$$

    This distribution can be regarded as a mixture of a distribution with moment generating function 1 and a mixture of a distribution with moment generating function $(1- \frac{\mu}{p}t)^{-1}$, i.e. the moment generating function of an exponential random variable with mean $\mu/p$.

    2.  Applying the properties of the moment generating function, $M_S^{(k)}(0) = \mathrm{E}[X^k]$.

    It follows that
$$ \frac{d}{dt} M_S(t) = \frac{p q \mu}{(p - \mu t)^2}, \quad \mathrm{E}[S] = \frac{q \mu}{p}$$
    and
$$ \frac{d^2}{dt^2} M_S(t) = \frac{2 p q \mu^2}{(p - \mu t)^3}, \quad \mathrm{E}[S^2] = \frac{2 q \mu^2}{p^2}.$$
    Therefore, $$\mathrm{Var}[S] = \mathrm{E}[S^2] - (\mathrm{E}[S])^2 = \frac{2 q \mu^2}{p^2} - \left(\frac{q \mu}{p}\right)^2  = \frac{q(2-q)\mu^2}{p^2}.$$

    Alternatively, the mean and variance of the aggregate claims for this time period can be calculated from the properties of a compound negative distribution (with k = 1),
$$\mathrm{E}[S] = \frac{q}{p} \mathrm{E}[X] = \frac{q \mu}{p},$$
    and 
$$\mathrm{Var}[S] = \frac{q}{p^2}(p \mathrm{E}[X^2] + q (\mathrm{E}[X])^2)  = \frac{q}{p^2} (p (2\mu^2) + q \mu^2) = \frac{q(2-q)\mu^2}{p^2}.$$


```{r tutorial3-4, echo = FALSE, }
policyLimit <- 125
lambda <- 0.02

n <- c(60,40)

lambda <- lambda*n
deductible <- c(10,0)

# First group of policies
x <- c(50,150,200)
px <- c(1/3,1/3,1/3)

x1 <- sapply(x-deductible[1], function(i){min(i, policyLimit)})
x1 <- unique(x1)
x2 <- sapply(x-deductible[2], function(i){min(i, policyLimit)})
x2 <- unique(x2)

# Hard coding
px1 <- c(1/3,2/3)
px2 <- c(1/3,2/3)

EX1 <- px1 %*% x1
EX2 <- px2 %*% x2

ES1 <- lambda[1]*EX1
ES2 <- lambda[2]*EX2
```

4. Let $Y$ be the aggregate claims paid by the insurer of 60 policies with a deductible of 10 and policy limit of 125. Then, $Y \sim \mathcal{CP}(60 \times 0.02, F_X)$, where $X$ is the individual claim amount paid by the insurer. The distribution of $X$ is

x | 40 | 125 
:-: | :-: | :-:
$\Pr(X = x)$ | 1/3 | 2/3

Hence, $\mathrm{E}[X] = 290/3$ and  $\mathrm{E}[Y] = 116$.

Let $U$ be the aggregate claims paid by the insurer of 40 policies with a deductible of 0 and policy limit of 125. Then, $U \sim \mathcal{CP}(40 \times 0.02, F_{X'})$, where $X'$ is the individual claim amount paid by the insurer. The distribution of $X'$ is

x | 50 | 125 
:-: | :-: | :-:
$\Pr(X' = x)$ | 1/3 | 2/3

Hence, $\mathrm{E}[X] = 100$ and  $\mathrm{E}[U] = 80$. The total expected total claim payout of the insurer is $116 + 80 = 196$.


```{r tutorial3-5, echo = FALSE, }
N <- c(0,1,2,3)
PN <- c(0.5,0.3,0.1,0.1)

EN <- N %*% PN
EN2 <- N^2 %*% PN
VN <- EN2 - (EN)^2

# X ~ uniform U(a,b)
a <- 0
b <- 100

EX <- 1/2*(a + b)
EX2 <- 1/3*(a^2 +a*b +  b^2)

ES <- EN*EX
VS <- EN*(EX2 - EX^2) + VN*EX^2
```

5. 
    1. The number of claims $N$ per a fixed time period has the following
    distribution:
    $$\Pr(N = `r N[1]`) = `r PN[1]`, \Pr(N = `r N[2]`) = `r PN[2]`, \Pr(N = `r N[3]`) = `r PN[3]`, \text{ and } \Pr(N = `r N[4]`) = `r PN[4]`.$$
Then, $\mathrm{E}[N] = `r EN`$ and $\mathrm{Var}[N] = `r VN`$.    
    
The loss distribution is uniformly distributed $X \sim \mathcal{U}(0,100)$. Then,
Then, $\mathrm{E}[X] = `r EX`$ and $\mathrm{E}[X^2] = `r EX2`$.  


The mean and variance of the aggregate claims for this fixed time period.
$$ \mathrm{E}[S] =  \mathrm{E}[N] \mathrm{E}[X] = `r ES` $$
and
$$ \mathrm{Var}[S] =  \mathrm{E}[N] (\mathrm{E}[X^2] - (\mathrm{E}[X])^2  ) + \mathrm{Var}[N] (\mathrm{E}[X])^2  = `r VS` .$$



    2.  Suppose that a policy deductible of 20 is in place. Then
$$\begin{aligned}
\mathrm{E}[\max(0, X - 20)] &= \int_{20}^{100} (x - 20) \frac{1}{100} \, dx\\
&= 32.
\end{aligned}$$

Therefore, the expected insurer's payout is
$$ \mathrm{E}[N]\mathrm{E}[\max(0, X - 20)] = (0.8)(32) = 25.6. $$





## Tutorial 4

1.  Given $X \sim \mathcal{G}(\alpha, \lambda)$, find the distribution of $Y = kX$
    for some positive $k$. Repeat the same question if

    1.  $X \sim \mathcal{G}(\alpha, \lambda)$, and

    2.  $X \sim \mathcal{LN}(\mu, \sigma^2)$.
    
    3.  $X \sim \mathcal{Pa}(\alpha, \lambda)$.

2.  Aggregate claims from a risk in a given time have a compound Poisson
    distribution with Poisson parameter $\lambda =  200$ and an
    individual claim amount distribution that is an exponential
    distribution with mean 500. The insurer has effected proportional
    reinsurance with proportion retained $\alpha = 0.8$.

    1.  Find the distribution of $S_I$ and $S_R$ and their means and
        variances.

    2.  Compare the variances $Var[S_I] +Var[S_R]$ and $Var[S]$. Comment
        on the results obtained.

3.  Show that if $N \sim \mathcal{NB}(k,p)$ represents the distribution of claim
    numbers, then the number of non-zero claims for the reinsurer is
    $$N_R \sim \mathcal{NB}(k,p^*),$$ where $p^* =  p/(p + (1-p)\pi_M$) and
    $\pi_M = Pr(X > M)$ for the claim size random variable $X$.

4.  The number of claims $N$ per a fixed time period has the following
    distribution:
    $$Pr(N = 0) = 0.5, Pr(N = 1) = 0.3, Pr(N = 2) = 0.1, \text{ and } Pr(N = 3) = 0.1.$$
    The loss distribution has Pareto distribution $Pa(4,1)$. Assume that
    the number of claims and the amount of losses are mutually
    independent. Find the mean and variance of the aggregate claims for
    this fixed time period.


## Solutions to Tutorial 4

1.
    1. Given $X \sim \mathcal{G}(\alpha, \lambda)$, the distribution of $Y = kX$ can be founded by using the moment generating function.

$$\begin{aligned}
M_Y(t) &= M_{kX}(t) = \mathrm{E}[e^{(tk)X}] = M_X(kt) \\
&= \left(\frac{\lambda}{\lambda - kt}\right)^\alpha \\
&= \left(\frac{\lambda/k}{\lambda/k - t}\right)^\alpha
\end{aligned}.
$$

Therefore, $Y \sim \mathcal{G}(\alpha, \lambda/k)$.

2. Note that for $X \sim \mathcal{LN}(\mu, \sigma^2)$, 
$$F_X(x) = \Pr(X \le x) = \Pr(\ln(X) \le \ln(x)) = \Pr(Z \le \frac{\ln(X) - \mu}{\sigma}),$$

where $Z \sim N(0,1)$.

Consider
$$\begin{aligned}
F_Y(x) &= \Pr(Y \le x) = \Pr(kX \le x) \\
&= \Pr(\ln(X) \le \ln(x/k)) \\
&= \Pr(\frac{\ln(X) - \mu}{\sigma} \le   \frac{\ln(x) - \ln(k) - \mu}{\sigma} ) \\
&= \Pr(Z \le   \frac{\ln(x) - \ln(k) - \mu}{\sigma} ). 
\end{aligned}
$$

It follows that $Y = kX \sim \mathcal{LN}(\mu + \ln(k), \sigma^2)$.

3. Given $X \sim \mathcal{Pa}(\alpha, \lambda)$,
$F_X(x) = 1 - \left(\frac{\lambda}{\lambda + x}\right)^\alpha$.

Therefore,

$$\begin{aligned}
F_Y(x) &= \Pr(Y \le x) = \Pr(kX \le x) = \Pr(X \le x/k) \\
&= 1 - \left(\frac{\lambda}{\lambda + (x/k)}\right)^\alpha \\
&= 1 - \left(\frac{\lambda k}{\lambda k + x}\right)^\alpha. 
\end{aligned}$$

Therefore, $Y = kX \sim \mathcal{Pa}(\alpha, k\lambda)$.




```{r tutorial4-2, echo = FALSE, }
# Compound Poisson Distribution
# CP(lambda,FX)
# N ~ Poisson(lambda) = Poisson(200)
# X ~ Exp(1/mu)

lambda <-200
muInit <- 500

#Proportional factor
alpha <- c(0.8,0.2)

r <- c(1,2)
# for insurer after proportional reinsurance
mu <- muInit*alpha

mrX <- gamma(r+1)*(muInit[1])^r
mrY <- gamma(r+1)*(mu[1])^r  #mrI[1] and mrI[2] (for insurer)
mrZ <- gamma(r+1)*(mu[2])^r

ES <- lambda*mrX[1]
VS <- lambda*mrX[2]


ESI <- lambda*mrY[1]
VSI <- lambda*mrY[2]

ESR <- lambda*mrZ[1]
VSR <- lambda*mrZ[2]
```

2. Given $X \sim \text{Exp}(\beta)$,  $kX \sim \text{Exp}(\beta/k)$, for $k > 0$.

    1. From $X \sim \text{Exp}(1/`r muInit`)$, the aggregate claim amount paid by the direct insurer $S_I$ is
$$S_I \sim \mathcal{CP}(`r lambda`,F_Y), \quad Y= \alpha X \sim \text{Exp}(\frac{1}{ (`r alpha[1]`) (`r muInit`)  })$$ and the aggregate claim amount paid by the direct insurer $S_R$ is
$$S_R \sim \mathcal{CP}(`r lambda`,F_Z), \quad Z= (1-\alpha) X \sim \text{Exp}(\frac{1}{ (`r alpha[2]`) (`r muInit`)  })$$

Moreover,
$$ \mathrm{E}[Y] = `r mrY[1]`, \quad \mathrm{E}[Y^2] = `r mrY[2]`, $$
$$ \mathrm{E}[Z] = `r mrZ[1]`, \quad \mathrm{E}[Z^2] = `r mrZ[2]`. $$

The total expected total claim payout of the insurer and its variance are
$$ \mathrm{E}[S_I] = `r ESI`, \quad \mathrm{Var}[S_I] = `r VSI`.$$
The total expected total claim payout of the reinsurer and its variance are
$$ \mathrm{E}[S_R] = `r ESR`, \quad \mathrm{Var}[S_R] = `r VSR`.$$

Alternatively, we know that
$$ \mathrm{E}[S] = (`r lambda`)\mathrm{E}[X] =  `r ES`, \quad \mathrm{Var}[S] = (`r lambda`)\mathrm{E}[X^2]  = `r VS`.$$
Hence, 
$$ \mathrm{E}[S_I] =  \mathrm{E}[\alpha S] =  (`r alpha[1]`)\mathrm{E}[S]  =  `r ESI`, \quad \mathrm{Var}[S_I] = \mathrm{Var}[\alpha S] =  (`r alpha[1]`)^2\mathrm{Var}[S] = `r VSI`.$$
$$ \mathrm{E}[S_R] =  \mathrm{E}[(1-\alpha) S] =  (`r alpha[2]`)\mathrm{E}[S]  =  `r ESR`, \quad \mathrm{Var}[S_R] = \mathrm{Var}[(1-\alpha) S] =  (`r 1 -  alpha[1]`)^2\mathrm{Var}[S] = `r VSR`.$$

    2. It follows that 
$\mathrm{Var}[S_I]  + \mathrm{Var}[S_R] = `r VSI + VSR` < `r VS` = \mathrm{Var}[S]$.   

    After effecting proportional reinsurance proportion, there is a reduction in the variability of the amount paid out by the insurer on claims.
    
3. Given $N \sim \mathcal{NB}(k,p)$, the probability generating function of $N$ is
$$P_N(r) = \left(\frac{p}{1- qr}\right)^k,$$
where $q = 1 - p$. 

Define the indicator random variable $\{I_j\}_{j=1}^\infty$, where
$$\begin{aligned}
        I_j = 
    \begin{cases}
        1 &\text{if }  X_j > M\\   
        0 &\text{if }  X_j \le M.
    \end{cases}\end{aligned}$$ Therefore, the number of non-zero claims for the reinsurer is $$N_R = \sum_{j= 1}^{N} I_j.$$
The variable $N_R$ has a compound distribution with its probability
generating function $$P_{N_R}(r) = P_N[P_I(r)],$$ where $P_I$ is the probability generating function of the indicator random variable. It can
be shown that $$P_I(r) = 1 - \pi_M + \pi_M r,$$ where
$\pi_M = \Pr(I_j = 1) = \Pr(X_j > M) = 1 - F(M)$. Therefore,
$$P_{N_R}(r) = P_N[P_I(r)] = \left(\frac{p}{1- q(1 - \pi_M + \pi_M r)}\right)^k.$$
Let $p* = \frac{p}{p + q \pi_M}$. By dividing both the numerator and the denominator above by $p + q \pi_M$, we have
$$P_{N_R}(r) = \left(\frac{p^*}{1 - q^* r}\right)^k,$$ and $N_R \sim \mathcal{NB}(k,p^*).$

```{r tutorial4-4, echo = FALSE, }

N <- c(0,1,2,3)
PN <- c(0.5,0.3,0.1,0.1)

EN <- N %*% PN
EN2 <- N^2 %*% PN
VN <- EN2 - (EN)^2

# X ~ Pareto U(a,b)
alpha <- 4
beta <- 1

m1 <- beta/(alpha-1)
m2 <- (2*beta^2)/ ((alpha - 1) * (alpha -2))
m3 <- (6*beta^3)/ ((alpha - 1) * (alpha -2) * (alpha -3))

ES <- EN*m1
VS <- EN*(m2 - m1^2) + VN*m1^2
Sk <- (lambda * m3)/(lambda * m2)^(3/2)
```

4. The number of claims $N$ per a fixed time period has the following
    distribution:
    $$\Pr(N = `r N[1]`) = `r PN[1]`, \Pr(N = `r N[2]`) = `r PN[2]`, \Pr(N = `r N[3]`) = `r PN[3]`, \text{ and } \Pr(N = `r N[4]`) = `r PN[4]`.$$
Then, $\mathrm{E}[N] = `r EN`$ and $\mathrm{Var}[N] = `r VN`$. 

The loss distribution has Pareto distribution $X \sim Pa(4,1)$. Therefore, $\mathrm{E}[X] = `r m1`$ and $\mathrm{E}[X^2] = `r m2`$.

Therefore, the mean and variance of the aggregate claim amount for this fixed time period.
$$ \mathrm{E}[S] =  \mathrm{E}[N] \mathrm{E}[X] = `r ES` $$
and
$$ \mathrm{Var}[S] =  \mathrm{E}[N] (\mathrm{E}[X^2] - (\mathrm{E}[X])^2  ) + \mathrm{Var}[N] (\mathrm{E}[X])^2  = `r VS` .$$



## Tutorial 5

1.  Aggregate claims from a risk in a given time have a compound Poisson
    distribution with Poisson parameter $10$ and an individual claim
    amount distribution that is a Pareto distribution $Pa(3,2000)$. The
    insurer sets a premium using the expected value principle with
    relative security loading of 0.15. The insurer is considering
    effecting excess of loss reinsurance with retention limit $1200$.
    The reinsurance premium would be calculated using the same principle
    with relative security loading of 0.2.

    1.  Calculate the insurer's expected profit before reinsurance.

    2.  Under excess of loss reinsurance, the insurer's profit is
        defined to be the premium charged by the insurer, less the
        reinsurance premium and less the claim paid by the insurer (also
        called net of reinsurance). Calculate the insurer's expected
        profit after effecting excess of loss reinsurance.

    3.  Comments on these results.

2.  Aggregate claims from a risk in a given time have a compound Poisson
    distribution with Poisson parameter $80$ and an individual claim
    amount distribution that is an exponential distribution with
    mean 10. The insurer has effected excess of loss reinsurance with
    retention level $M = 20$.

    1.  Find the distribution of $S_I$ and $S_R$ and their means and
        variances.

    2.  Compare the variances $Var[S_I] +Var[S_R]$ and $Var[S]$. Comment
        on the results obtained.

3.  Aggregate claims $S$ have a compound Poisson distribution
    $\mathcal{CP}(\lambda,F_X)$ where $\lambda = 0.5$ and an individual
    claim amounts $X$ are either 1, 2 or 3 with probability 1/2, 1/4 and
    1/4 respectively. Calculate $g_r$ for $r = 0,1,\ldots, 10$.

4.  (Required the use of Excel or R)

    Suppose $\{ S(t) \}_{t \ge 0}$ is a compound Poisson process with
    Poisson parameter 1 and individual claim distribution that is an
    exponential distribution $Exp(1)$ so that for each fixed $t$,
    $S(t) \sim \mathcal{CP}(t, F_X)$ where $F_X(x) = 1 - e^{-x}$, for
    $x > 0$.

    1.  Calculate the mean, variance and coefficient of skewness of
        $S(1)$.

    2.  Use (a) the normal approximation and (b) the translated Gamma
        approximation to approximate the values of $Pr(S(10) > 20)$.

    3.  Use (a) the normal approximation and (b) the translated Gamma
        approximation to approximate the values of $Pr(S(100) > 120)$.




 
```{r tutorial5-1, echo = FALSE, }
# Compound Poisson Distribution
# CP(lambda,FX)
# N ~ Poisson(lambad) = Poisson(10)
# X ~ \mathcal{Pa}(alpha,beta)= \mathcal{Pa}(2,1)

lambda <-10
alpha <- 3
beta <- 2000


r <- c(1,2)
mr <- (beta^r)*(gamma(alpha - r)*gamma(1 + r))/gamma(alpha)


ES <- lambda*mr[1]
VS <- lambda*mr[2]
Sk <- (lambda * mr[3])/(lambda * mr[2])^(3/2)   

# Excess of loss reinsurance
M <- 1200
piM <- ppareto(M,shape = alpha, scale = beta, lower.tail = FALSE)

# Define W = X - M | X > M ~ \mathcal{Pa}(alpha,beta+M)
# Calculate E[W], E[W^2]
r <- c(1,2)
mrR <- ((beta+M)^r)*(gamma(alpha - r)*gamma(1 + r))/gamma(alpha)


lambdaR <- lambda*piM
ESR <- lambdaR*mrR[1]
VSR <- lambdaR*mrR[2]

theta  <- 0.15
thetaR <- 0.2

# Expected profit before reinsurance
EProfitBR <- theta*ES

# Expected profit after excess of loss reinsurance
EProfitAR <- theta*ES - thetaR*ESR

# the percentage reduction in the expected profit
reductionExpProfit <- 100*(EProfitBR - EProfitAR)/EProfitBR


### From X = Y + Z, now we will calculate E[Y^2] (see the formula from Gray p254)

eta <- beta/(beta + M)
EY2 <- (2*beta)*(beta*(1 - eta^(alpha - 2)) - (alpha -2)*M*eta^(alpha-1) )/((alpha-1)*(alpha-2))

ESI <- ES - ESR
VSI <- lambda*EY2

# the percentage reduction in the SD of  profit
reductionVarProfit <- 100*(sqrt(VS) - sqrt(VSI))/sqrt(VS)


```


## Solutions to Tutorial 5

1. 
    1. Aggregate claims $S$ from a risk in a given time have a compound Poisson
    distribution $S \sim \mathcal{CP}(10,F_X)$ where $X \sim \mathcal{Pa}(\alpha,\beta) = \mathcal{Pa}(3,2000)$. Using the expected value principle, the insurer sets a premium before reinsurance $P = (1 + \theta)\mathrm{E}[S]$ with relative security loading of $\theta = 0.15$. The insurer's expected profit before reinsurance can be obtained from
$$\begin{aligned} 
\mathrm{E}[\text{Profit}] &=  \mathrm{E}[P-S] \\
&= P-  \mathrm{E}[S]  \\
&= (1 + \theta)\mathrm{E}[S] - \mathrm{E}[S] \\
&= \theta\mathrm{E}[S]
\end{aligned}$$    

Note that $\mathrm{E}[S] = \lambda \mathrm{E}[X] = (`r lambda`)(`r mr[1]`)  = `r ES`$. Hence $\mathrm{E}[\text{Profit}]  = `r EProfitBR`$.

    
    2. The insurer is considering effecting excess of loss reinsurance with retention limit $M = 1200$.
The reinsurance premium would be calculated using the same principle with relative security loading of $\theta_R = 0.2$. The insurer's expected profit after reinsurance can be obtained from (in terms of $\mathrm{E}[S]$ and $\mathrm{E}[S_R]$) 
$$\begin{aligned} 
\mathrm{E}[\text{Profit (after reinsurance)}] &=  \mathrm{E}[P- P_R - S_I] \\
&= P- P_R - \mathrm{E}[S_I]  \\
&= P- P_R - \mathrm{E}[S - S_R]  \\
&= (1 + \theta)\mathrm{E}[S] - (1 + \theta_R)\mathrm{E}[S_R] - \mathrm{E}[S] +  \mathrm{E}[S_R]\\
&= \theta\mathrm{E}[S] - \theta_R\mathrm{E}[S_R]
\end{aligned},$$  
where $P_R$ is the reinsurer premium. 

The total claim amount paid by reinsurer $S_R \sim \mathcal{CP}(10 \pi_M,F_W)$, where $\pi_M = \Pr(X > M)$ is the proportion of claims involved the reinsurer, $W \sim X - M|X > M$ and $F_W \sim \mathcal{Pa}(\alpha,\beta + M) =  \mathcal{Pa}(3,3200)$. It follows that
$$\mathrm{E}[S_R] = (`r lambda`)(`r piM`)\mathrm{E}[W] =  (`r lambda`)(`r piM`)(`r mrR[1]`) = `r ESR`.$$
Substituting this into the above equation yields
$$ \mathrm{E}[\text{Profit (after reinsurance)}] = `r EProfitAR`.$$

3. Consider the variance of the profit, firstly without reinsurance. The insurer’s profit is equal to premiums charged less claims paid. Since only the claims are random, the variance of the profit (before reinsurance) is the same as the variance of the total claims.
$$ \mathrm{Var}[\text{Profit (without reinsurance)}] = `r VS`.$$
With reinsurance, the insurer’s profit is equal to premiums charged less the reinsurance premium less the net claims paid. So if the insurer’s aggregate net claims paid are $S_I$ , then the variance of the profit is equal to the variance of $S_I$.

$$ \mathrm{Var}[\text{Profit (with reinsurance)}] = `r VSI`.$$

+ The percentage reduction in the expected profit is `r round(reductionExpProfit ,2)`$\%$.

+ The percentage reduction in the standard deviation of the profit is `r round(reductionVarProfit ,2)`$\%$.

Note that here the reinsurance has a greater effect on the variability of the claim size than on the average, ie the standard deviation is reduced by a greater percentage than the mean. This is very often the case for excess-of-loss reinsurance.

```{r tutorial5-2, echo = FALSE }
# Compound Poisson Distribution
# CP(lambda,FX)
# N ~ Poisson(lambda) = Poisson(80)
# X ~ Exp(beta)

lambda <-80
beta <- 1/10

#retention level M = 20
M <- 20

mu <- 1/beta

#The proportion of claims which involve the reinsurer 
p <- exp(-M/mu)

EZ <- p*mu
EZ2 <- 2*p*mu^2
VZ <- EZ2 - EZ^2
covZ <- sqrt(VZ)/EZ


EX <- 1/beta
EX2 <- 2/beta^2

EY <- (1- exp(-beta*M))*EX

VY <- (1/beta^2)*(2 - exp(-beta*M)*( (beta*M)^2 + 2*(beta*M) + 2 )  ) + M^2*(exp(-beta*M)) - (EY)^2

EY2 <- 2*mu* (  mu*(1 - exp(-M/mu)) - M*exp(-M/mu)   )
VY <- EY2 - (EY)^2  
covY <- sqrt(VY)/EY


EZ <- exp(-M*beta)*EX
EZ2 <- 2*mu^2*exp(-M/mu)
VZ <- EZ2 - (EZ)^2  
covZ <- sqrt(VZ)/EZ
####


ES <- lambda*EX
VS <- lambda*EX2


ESI <- lambda*EY
VSI <- lambda*EY2

ESR <- lambda*EZ
VSR <- lambda*EZ2
```


2. Given $X \sim \text{Exp}(\beta)$ with $\beta = 1/10$,

    1. The aggregate claim amount paid by the direct insurer $S_I$ is
$$S_I \sim \mathcal{CP}(`r lambda`,F_Y), \quad Y= \min(X,M)$$ 
The distribution and its first two moments of $Y$ can be found as shown in the lecture note (Section 3.4 Excess of Loss Reinsurance) or by using the moment generating function. Here we will use the moment generating function.

From $X \sim \mathrm{Exp}(\beta) = \mathrm{Exp}(1/\mu)$ (Note that $\mu$ is the expected value of $X$),
$$ M_Y(t) = \frac{1}{1- \mu t} ( 1 - \mu p t e^{Mt}),$$
where $p = \Pr(X > M) = e^{-\lambda M} = e^{-\lambda/\mu}$ is the proportion of claims which involve the reinsurer (see the [link](https://math.stackexchange.com/questions/3033272/finding-the-moment-generating-function-of-miny-1) for more helps)

It follows that
$$\begin{aligned}
\mathrm{E}[Y] &= M_Y'(0) = (1 - p)\mu = `r EY` \\
\mathrm{E}[Y^2] &= M_Y''(0) = -2 \mu (M p + (-1 + p) \mu) = `r EY2`. 
\end{aligned}
$$

The total expected total claim payout of the insurer and its variance are
$$ \mathrm{E}[S_I] = \lambda \mathrm{E}[Y] = `r ESI`, \quad \mathrm{Var}[S_I] = \lambda \mathrm{E}[Y^2] =  `r VSI`.$$



The aggregate claim amount paid by the reinsurer $S_R$ is
$$S_R \sim \mathcal{CP}(`r lambda`,F_Z), \quad Z= \max(0,X-M)$$

It follows that
$$\begin{aligned}
\mathrm{E}[Z] &= p\mu = `r EZ` \\
\mathrm{E}[Z^2] &= 2 \mu^2 p = `r EZ2`. 
\end{aligned}
$$

The total expected total claim payout of the insurer and its variance are
$$ \mathrm{E}[S_R] = \lambda \mathrm{E}[Z] = `r ESR`, \quad \mathrm{Var}[S_R] = \lambda \mathrm{E}[Z^2] =  `r VSR`.$$

    2. It follows that 
$\mathrm{Var}[S_I]  + \mathrm{Var}[S_R] = `r VSI + VSR` < `r VS` = \mathrm{Var}[S]$.   

    After excess of loss reinsurance arrangement, there is a reduction in the variability of the amount paid out by the insurer on claims.
    
    

```{r tutorial5-3, echo = FALSE, }
fx <- c(0,1/2,1/4,1/4)
lambda <- 0.5
Fs <- aggregateDist("recursive", model.freq = "poisson",
                    model.sev = fx, lambda = lambda)

gr <- round(c(Fs(0), diff(Fs(0:11))),6)  # probability mass function
#plot(c(Fs(0), diff(Fs(0:11))) )     
```

3. From Panjer's recursion formula,
$$ g_r = \frac{\lambda}{r}\sum_{j=1}^r j f_j g_{r-j}.$$
Therefore,
$$\begin{aligned}
g_0 &= e^{-\lambda} = `r gr[1]` \\
g_1 &= \lambda f_1 g_0  = `r gr[2]` \\
g_2 &= (\lambda/2)(f_1 g_1 + 2 f_2 g_0)  = `r gr[3]` \\
g_3 &= (\lambda/3)(f_1 g_2 + 2 f_2 g_1 + 3 f_3 g_0)  = `r gr[4]` \\
g_4 &= (\lambda/4)(f_1 g_3 + 2 f_2 g_2 + 3 f_3 g_1)  = `r gr[5]` \\
    &\vdots \\
g_r &=  (\lambda/r)(f_1 g_{r-1} + 2 f_2 g_{r-2} + 3 f_3 g_{r-3}).
\end{aligned}
$$
Also $g_5 - g_{10} = `r gr[6:11]`$, respectively.


## Tutorial 6

1.  Suppose $S \sim \mathcal{CP}(\lambda, F_X)$ where individual claim
    amounts are distributed on the positive integers and
    $\lambda = 0.5$. An individual claim amounts $X$ are either 1 or 2
    with probability 2/3 and 1/3 respectively.

    1.    Write down an expression for $E[S]$ in terms of $\lambda$ and the mean of $X$.

    2.  Use Panjer's recursion to show that
        $$g_r = \frac{1}{3r} (g_{r-1} + g_{r-2}), \quad r = 2,3,\ldots.$$

    3.  Calculate $g_r$ for $r = 0,1,2, 3, 4$.

    4.  Verify that $\sum_{r=0}^4 g_r > 0.995$.

    5.  Compare $\sum_{r=0}^4 r g_r$ with the exact mean of $S$ computed by using 1.1.

    6.  Comment on the results.

2.  Consider a portfolio of 1000 life insurance policies over a one-year
    time period. For each policy at most one claim can occur in the
    year. The probability that a claim occurs is 0.04. Claim amounts are
    distributed $X \sim Exp(1/2)$.

    1.  Calculate the mean and variance of the aggregate claims.

    2.  Calculate the relative security loading $\theta_1$ such that the
        probability of a profit on this portfolio is 0.95.

    3.  Suppose that the insurer imposes a deductible of 1. Calculate
        the mean and the variance of the aggregate claim paid by the
        insurer. Also calculate the relative security loading $\theta_2$
        such that the probability of a profit on this portfolio is 0.95.

    4.  Comment on the difference between $\theta_1$ and $\theta_2$.

3.  A portfolio of 5000 life insurance policies for one year term with
    the benefit amount as shown in the table

      Benefit amount         1      2
      -------------------- ------ ------
      Number of policies    4000   1000

    The policyholders can be assumed to be independent and the
    probability that a claim occurs is 0.03.

    1.  Calculate the mean and variance of the aggregate claims.

    2.  Use the normal approximation to compute $Pr(S > 200)$

    3.  The insurer aims to reduce the size of $Pr(S > 200)$. The
        insurer arranges excess loss reinsurance with retention 1.5. The
        reinsurer calculates the reinsurance premium $P_R$ by using the
        relative security loading of 20%. Calculate the reinsurPrance
        premium.

    4.  After reinsurance, calculate the mean and variance of the
        aggregate claims paid out by the insurer, i.e. $E[S_I]$ and
        $E[S_I]$.

    5.  Calculate $Pr(S_I + P_R > 200)$.

    6.  Comment on the results.

4.  An insurance company issues travel insurance policies. There are two
    types of claims with a maximum of one claim per policy.

    Type I claims for delay : Claim amounts follow an Exponential
    distribution with parameter $\lambda = 0.002$.

    Type II claims for a flight cancellation: Claim amounts follow a
    Uniform distribution $U(20,000, 50,000)$.

    Suppose that 10% of policies result in a claim, 80% of which are
    Type I and the remaining are type II.

    Calculate the premium charged for each policy **provided that a premium loading factor of 10\% is applied**.



## Solutions to Tutorial 6

1. $S \sim \mathcal{CP}(\lambda, F_X)$ where
$\lambda = 0.5$ and an individual claim amounts $X$ are either 1 or 2
with probability 2/3 and 1/3 respectively.

    1. $E[S] = \lambda \cdot E[X]$.
    
    2. The Panjer's recursion formula $g_r$ can be recursively calculated by

$g_0 = p_0 = \Pr(S = 0) = \exp(-\lambda)$,

$g_r= \Pr(S = r) = \frac{\lambda}{r}\sum_{j=1}^r j\cdot f_j \cdot g_{r-j} = = \frac{\lambda}{r}\sum_{j=1}^2 j\cdot f_j \cdot g_{r-j}, \quad r = 1,2 \ldots.$

This follows from $f_j = 0$ for $j \ge 3$. Hence,

$$g_r = \frac{1}{2r}(1\cdot\frac{2}{3}\cdot g_{r-1} + 2\cdot\frac{1}{3}\cdot g_{r-2}) = \frac{1}{3r} (g_{r-1} + g_{r-2}),$$

for $r = 2,3,\ldots$.

```{r tutorial6-1, echo = FALSE }
lam <- 0.5 
f1 <- 2/3
f2 <- 1/3
g0 <- exp(-lam)
g1 <- lam*f1*g0
g2 <- 1/(3*2)*(g1 + g0)
g3 <- 1/(3*3)*(g2 + g1)
g4 <- 1/(3*4)*(g3 + g2)

```


    3. Following the Panjer's recursion formula, we have
$$
\begin{aligned}
g_0 &= `r g0` \\
g_1 &= `r g1` \\
g_2 &= `r g2` \\
g_3 &= `r g3` \\
g_4 &= `r g4`.
\end{aligned}
$$

    4. Clearly, 
$\sum_{r=0}^4 g_r > 0.995$.

    5. From 1.1, 
$E[S] = \lambda \cdot E[X] = \frac{1}{2} \cdot \frac{4}{3} = \frac{2}{3}$. However, 
 $$\sum_{r=0}^4 r \cdot g_r \approx  0.6418.$$
 
    6. Truncating the distribution of 
$S$ at $r=4$ gives more than 99.5% of the probability mass but only $\frac{0.6418}{2/3} \approx 96\%$ of the mean.


2. The aggregate claim $S$ in this portfolio has a compound binomial
distribution, denoted by $\mathcal{CB}(n,p,F_X)$ with $n = 100$, $p = 0.04$ and $X \sim Exp(\lambda)$, where $\lambda = 1/2$.

```{r tutorial6-2, echo = FALSE }
n <- 1000
p <- 0.04
d <- 1 #deductible

lam2 <- 1/2
EX <- 1/lam2
EX2 <- 2/lam2^2


ES <- n*p*EX
VS <- n*p*(EX2- p*EX^2)

theta1 <- qnorm(0.95)*sqrt(VS)/ES

pstar <- p*exp(-lam2*d)

EY <- EX
EY2 <- EX2

ESD <- n*pstar*EY
VSD <- n*pstar*(EY2- pstar*EY^2)

theta2 <- qnorm(0.95)*sqrt(VS)/ES
```


    1. From $X \sim Exp(1/2)$,
$$
\begin{aligned}
E[X] &= 1/\lambda = `r EX` \\
E[X^2] &= 2/\lambda^2 = `r EX2`.
\end{aligned}
$$


It follows that

$$
\begin{aligned}
E[S] &= n p m_1 = `r ES`, \\
Var[S] &= np m_2 - n p^2 m_1^2 = `r VS`.
\end{aligned}
$$

    2. The profit on this portfolio is
$$(1+\theta)E[S] - S.$$
To calculate the relative security loading $\theta_1$ such that the probability of a profit on this portfolio is 0.95, we require
$$0.95 = \Pr((1+\theta)E[S] - S).$$
Suppose that the aggregate claims can be approximated by the normal distribution, i.e. $S \sim \mathcal{N}(\mathrm{E}[S],\mathrm{Var}[S]) = \mathcal{N}(`r ES`,`r VS`)$. Therefore,
$$
\begin{aligned}
0.95 &= \Pr( P - S > 0)  \\
&= \Pr( ( 1 + \theta_1)(`r ES`) - S > 0)  \\
&= \Pr( S < ( 1 + \theta_1)(`r ES`) ) \\
&= \Pr( Z < \frac{( 1 + \theta_1)(`r ES`) - `r ES` }{\sqrt{`r VS`}} ) \\
&= \Pr( Z < \frac{( \theta_1)(`r ES`) }{\sqrt{`r VS`}} ).
\end{aligned}
$$
This gives $\frac{( \theta_1)(`r ES`) }{\sqrt{`r VS`}} = `r qnorm(0.95)`$ and 
$$\theta_1 = `r theta1`.$$
    3. Suppose that the insurer imposes a deductible of $d= 1$. Let
$$Y^* = X-d|X>d$$
be the claim amount with which the insurer is involved.

Note that for $X \sim Exp(\lambda)$, where $\lambda = 1/2$, $Y^* \sim Exp(\lambda) = Exp(1/2)$ (due to the memorylessness property of the exponential distributions). Hence,
$$
\begin{aligned}
E[Y^*] &= 1/\lambda = `r EX` \\
E[(Y^*)^2] &= 2/\lambda^2 = `r EX2`.
\end{aligned}
$$

With the deductible in place, the probability of a claim is

$$p^* = p \cdot \Pr(X > d) = p \cdot e^{-\lambda d} = `r pstar`$$

Hence, 
$$
\begin{aligned}
E[S^*] &= n p^* E[Y^*]  = `r ESD`, \\
Var[S^*] &= np^* E[(Y^*)^2] - n (p^*)^2 (E[Y^*])^2 = `r VSD`.
\end{aligned}
$$

Then, using the same argument as before, we have $\theta_2 = `r theta2`.$

    4. With the deductible, the security loading has gone up. The deductible has reduced the variability from 
$\sqrt(`r VS`)$ to $\sqrt(`r VSD`)$. Moreover, the expected claim amount has been reduced by a greater factor from $`r ES`$ to $`r ESD`$.

Using a normal approximation, the relative security loading depends on the coefficient of variation, which is defined by the ratio of the standard deviation to the mean,
$$\text{CV = Standard Deviation/Mean}.$$

The larger this is, the larger the relative security loading required, which can be varified by
$$\frac{\sqrt{`r VS`}}{`r ES`} < \frac{\sqrt{`r VSD`}}{`r ESD`}.$$


3. From A portfolio of 5000 life insurance policies for one year term with the benefit amounts 

      Benefit amount         1      2
      -------------------- ------ ------
      Number of policies    4000   1000
      

```{r tutorial6-3, echo = FALSE }
b1 <- 1 #benefit amount
b2 <- 2

n1 <- 4000 #no. of policies
n2 <- 1000

p <- 0.03 # prob of a claim

ES1 <- b1*n1*p
ES2 <- b2*n2*p
ES <- ES1 + ES2

VS1 <- b1^2*n1*p*(1-p)
VS2 <- b2^2*n2*p*(1-p)
VS <- VS1 + VS2

z <- (200 - ES)/sqrt(VS)

prob <- 1 - pnorm(z,0,1)

M <- 1.5
ESR <- (b2-M )*n2*p

thetaR <- 0.2
PR <- (1+thetaR)*ESR


VS1I <- b1^2*n1*p*(1-p)
VS2I <- (M)^2*n2*p*(1-p)
VSI <- VS1I + VS2I

ESI <- ES - ESR

z2 <- (200 - ESI - PR)/sqrt(VSI)
prob2 <- 1 - pnorm(z2,0,1)

ratio <- 100*(prob - prob2)/prob

```

      
    1. The aggregate claims $S$ is given by
$$S = 1\cdot N1 +2\cdot N2, $$
where $N_1 \sim Bin(4000,0.03)$ and $N_2 \sim Bin(1000,0.03)$ are the number of claims with the benefit amounts of 1 and 2, respectively.



Therefore,
$$
\begin{aligned}
E[S] &= 1\cdot E[N1] +2\cdot E[N2] = `r ES`, \\
V[S] &= 1^2\cdot V[N1] +2^2\cdot V[N2] = `r VS`.
\end{aligned}
$$
    2. Suppose that the aggregate claims can be approximated by the normal distribution, i.e. $S \sim \mathcal{N}(\mathrm{E}[S],\mathrm{Var}[S]) = \mathcal{N}(`r ES`,`r VS`)$. It follows that
$$
\begin{aligned}
\Pr(S > 200) &= \Pr(\frac{S - E[S]}{\sqrt{V[S]}} > \frac{200 - `r ES`}{\sqrt{`r VS`}}) \\
&= \Pr(Z > `r z`) \\
&= `r prob`.
\end{aligned}
$$

    3. Let 
$S_R$ be the aggregate claim amount paid by the reinsurer. With the retention limit of 1.5, 
$$E[S_R] = `r n2` \cdot (`r b2` - `r M`) \cdot p = `r ESR`.$$
Therefore, 
$$P_R = (1 + \theta_R) \cdot E[S_R] = `r PR`.$$
    4. After the reinsurance arrangement, 

$$E[S_I] = E[S] - E[S_R] = `r ES - ESR`.$$

By replacing 2 by 1.5 in 3.1, 
$$V[S_I] = `r VSI`.$$

    5. To calculate 
$\Pr(S_I + P_R > 200)$, we assume that the aggregate claims can be approximated by the normal distribution, i.e. $S_I \sim \mathcal{N}(\mathrm{E}[S_I],\mathrm{Var}[S_I]) = \mathcal{N}(`r ESI`,`r VSI`)$. It follows that

$$
\begin{aligned}
\Pr(S_I + P_R > 200) &= \Pr(S_I  > 200 - P_R) \\
&= \Pr(\frac{S_I - E[S_I]}{\sqrt{V[S_I]}} > \frac{200 - `r PR` - `r ES`}{\sqrt{`r VS`}}) \\
&= \Pr(Z > `r z2`) \\
&= `r prob2`.
\end{aligned}
$$

    6. The probability that 
$\Pr(\text{Cost} > 200)$ has increased from `r prob` to `r prob2`, i.e. about `r abs(ratio)`%. This reflects the fact that the cost of the reinsurance $P_R$ is too expensive.

4. Let $X$ denote an individual claim amount. From the conditional expectation formula, it follows that

```{r tutorial6-4, echo = FALSE }
pt1 <- 0.8   #prob of type 1 claim
pt2 <- 1-pt1

lambdat1 <- 0.002     #for Exponential dist for type I
at2 <- 20000        # U(a,b) for type II
bt2 <- 50000

EXt1 <- 1/lambdat1
EXt2 <- (1/2)*(at2 + bt2)

EX <- pt1*EXt1 + pt2*EXt2

prop_claims <- 0.1 # proportion of policies result in a claim
theta <- 0.15  #Security loading

premium <-  prop_claims*EX*(1+theta)
```


$$
\begin{aligned} 
E[X] &= E[E[X|\text{type}]] \\
&=  \Pr(\text{Type I}) \, E[X|\text{Type I}]   + \Pr(\text{Type II}) \, E[X|\text{Type II}]   \\
&= `r pt1` \cdot `r EXt1 ` + `r pt2` \cdot `r EXt2 ` \\
&= `r EX`.
\end{aligned}
$$

Furthermore, assuming that 10% of policies result in a claim and that a premium loading factor of 10\% is applied, the premium is 

$$`r prop_claims` \cdot `r EX `\cdot (1 + `r theta`) = `r premium`.$$




## Tutorial 7

1.  1.  An insurer has initial surplus $u$ of 5.5 (in suitable units)
        and receives premium payments at a rate of 3 per year. Suppose
        claims from a portfolio of insurance over the first two years
        are as follows:

          Time (years)    0.3   0.8   1.5
          -------------- ----- ----- -----
          Amount           4     6     2

        Plot a surplus process and determine whether ruin occurs within
        the first two years in each of the following cases:

        1.  Ruin was checked continuously.

        2.  Ruin was checked only at the end of each year.

    2.  Suppose that the insurer has arranged excess loss reinsurance
        with retention limit 3.5. The reinsurance premium is 1 per year
        to be paid continuously. Plot a surplus process and determine
        whether ruin occurs within the first two years n each of the
        following cases:

        1.  Ruin was checked continuously.

        2.  Ruin was checked only at the end of each year.

    3.  Comment on the results.

2.  The aggregate claims process for a risk is compound Poisson with
    Poisson parameter 0.1 per year. Individual claim amounts $X$ have
    the following distribution:

           $x$       50     75    120
      ------------- ----- ------ ------
       $Pr(X = x)$   0.7   0.25   0.05

    The insurer's initial surplus is 100 (in suitable units) and the
    insurer calculate the premium using a relative security loading of
    10% on the expected amount of annual aggregate claim at the
    beginning of each year. Calculate the probability that the insurer's
    surplus at time 2 will be negative.

3.  The aggregate claims process for a risk is compound Poisson with
    Poisson parameter 0.1 per year. Individual claim amounts $X$ have
    the following distribution:

           $x$        1     2
      ------------- ----- -----
       $Pr(X = x)$   0.7   0.3

    The insurer's initial surplus is 0.3 (in suitable units) and the
    premium rate is 0.4 per year, received continuously. Calculate the
    following probabilities of ruin.

    1.  $\psi(0.3,1).$

    2.  $\psi(0.3,2).$



## Solutions to Tutorial 7




```{r echo = FALSE}
St <- c(4,6,2)
ti <- c(0.3,0.8,1.5)
cumSt <- cumsum(St)
u <- 5.5
c <- 3

U <- function(t){ ifelse(( t < ti[1]) , u + c*t, 
    ifelse( ( ti[1] <= t & t < ti[2]), u + c*t - cumSt[1],
    ifelse( ( ti[2] <= t & t < ti[3]), u + c*t - cumSt[2],  
    ifelse( ( ti[3] <= t), u + c*t - cumSt[3],NA))))}



#plot(U,xlim=c(0,2), ylim = c(-1, 2), col = "red", xlab = expression(italic("t")), ylab = expression(italic("U(t)"))) 
#abline(v = 0, h = 0)
```

1.

a) The insurer's surplus (or cash flow) at any future time $t$ (> 0) is a random variable, since its value depends on the claims experience up to time $t$. The insurer's surplus at time $t$ is a random variable. The insurer's surplus at time $t$ is denoted $U(t)$. The following formula for $U(t)$ can be written as

\begin{equation}
U(t) = u + ct - S(t) = `r u` + `r c` t - S(t),
\end{equation} 
where the **aggregate claim amount up to time**
$t$, $S(t)$ is 
\begin{equation}
S(t) = \sum_{i = 1}^{N(t)} X_i .
\end{equation}


The following table summarises the values of the surplus function at the time when claims occurs. 


Time | Surplus (before claim) | Surplus (after claim)
:-: | :-: | :-: 
0 | `r u` | `r u`
`r ti[1]` | `r U(ti[1]) + St[1]` | `r U(ti[1])`
`r ti[2]` | `r U(ti[2]) + St[2]` | `r U(ti[2])`
`r ti[3]` | `r U(ti[3]) + St[3]` | `r U(ti[3])`

The surplus function increases at a constant rate $c$ until there is a claim and the surplus drops by the amount of the claim. The surplus then increases again at the same rate $c$ and drops are repeated when claims occur. In this example,
ruin occurs at time `r ti[3]`.
The plot of the surplus process is given in the following figure.

```{r echo = FALSE, fig.cap = 'The surplus process befor reinsurance arrangment.'}
plot(U,xlim=c(0,2), ylim = c(-3, 8), col = "red", xlab = expression(italic("t")), ylab = expression(italic("U(t)"))) 
abline(v = 0, h = 0)
```


i. Ruin occurs at time 0.8 when ruin is checked continuously.

ii. Similarly, we have $U(1) = `r U(1)`$ and $U(2) = `r U(2)`$. Therefore, ruin occurs at time 1 and 2 when ruin is checked at the end of each year.
    
    

```{r echo = FALSE}
St <- c(4,6,2)
ti <- c(0.3,0.8,1.5)

M <- 3.5 #Retention limit

# now cumSt are paid amounts by insurer
cumSt <- cumsum(pmin(St,M))
u <- 5.5
c <- 3
cr <- 1


#a <- 0.7

U <- function(t){ ifelse(( t < ti[1]) , u + (c - cr)*t, 
    ifelse( ( ti[1] <= t & t < ti[2]), u + (c - cr)*t - cumSt[1],
    ifelse( ( ti[2] <= t & t < ti[3]), u + (c - cr)*t - cumSt[2],  
    ifelse( ( ti[3] <= t), u + (c - cr)*t - cumSt[3],NA))))}



#plot(U,xlim=c(0,2), ylim = c(-1, 2), col = "red", xlab = expression(italic("t")), ylab = expression(italic("U(t)"))) 
#abline(v = 0, h = 0)
```

b) The insurer's net premium income is `r c - cr` per year. The insurer's cash flow or surplus process is now given by 
\begin{equation}
U_I(t) = u + (c - c_r)t - S_I(t) = `r u` + (`r c` - `r cr`) t - S_I(t),
\end{equation} 
where $c_r$ is the reinsurance premium rate. Claims that are involved the insurer after are 

| Time (year) | 0.3 | 0.8 | 1.5 |
|-------------|:---:|:---:|:---:|
| Amount      | 3.5 | 3.5 |  2  |


The following table summarises the values of the surplus function at the time when claims occurs. 

Time | Surplus (before claim) | Surplus (after claim)
:-: | :-: | :-: 
0 | `r u` | `r u`
`r ti[1]` | `r U(ti[1]) + min(St[1],M)` | `r U(ti[1])`
`r ti[2]` | `r U(ti[2]) + min(St[2],M)` | `r U(ti[2])`
`r ti[3]` | `r U(ti[3]) + min(St[3],M)` | `r U(ti[3])`

```{r echo = FALSE, fig.cap = 'The surplus process under a reinsurance arrangement.'}
plot(U,xlim=c(0,2), ylim = c(-3, 8), col = "red", xlab = expression(italic("t")), ylab = expression(italic("U(t)"))) 
abline(v = 0, h = 0)
```

Under the reinsurance arrangement, 

i. Ruin occurs at time 1.5 when ruin is checked continuously.

ii. Similarly, we have $U(1) = `r U(1)`$ and $U(2) = `r U(2)`$. Therefore, ruin does not occur when ruin is checked at the end of each year.


```{r echo = FALSE}
lambda <- 0.1
theta <- 0.1 #Security loading

u <- 100
x <- c(50,75,120)
px <- c(0.7,0.25,0.05)

EX <- sum(x*px)

ES <- lambda*EX

c <- (1+theta)*ES

s0 <- u + 2*c # We require S(2) <= s0

t<-2
pn0 <- dpois(0,t*lambda)
pn1 <- dpois(1,t*lambda)
pn2 <- dpois(2,t*lambda)

px50 <- px[which(x==50)]
px75 <- px[which(x==75)]


pS2 <- pn0 + pn1*px50 + pn1*px75 + pn2*px50*px50
```


2. According to the property of the aggregate claims process $S(t)$, 
the aggregate claims in the $n$th year, for $n = 1,2, \ldots$ are
$S(n) - S(n-1) \sim \mathcal{CP}(\lambda, F_X(x))$, all of them have the same compound Poisson distribution with the same parameters. Hence, the premium rate per year will be constant which can be obtained from
$$c = (1 + \theta)\text{E}[S],$$ where $\theta = `r theta`$. 
Note that $\text{E}[S] = \lambda \text{E}[X] = `r lambda` \cdot `r EX` = `r ES`$ and hence
$c = `r c`.$

The surplus at time 2 is
$$U(2) = u + ct - S(2) = `r u` + `r c` \cdot 2 - S(2) = `r u+2*c`  - S(2).$$
So the required probability is
$$\Pr(U(2) < 0) = \Pr(S(2) > `r u + 2*c`) = 1- \Pr(S(2) \le `r u + 2*c`).$$
We consider all possibilities that $S(2) \le s0$. According to the information from the following table, 

| Number of claims | Amount of claims |
|------------------|------------------|
|      0 claim     |         0        |
|      1 claim     |     50 or 75     |
|     2 claims     |   100 = 50 + 50  |
It follows that
$$
\begin{aligned}
\Pr(S(2) \le `r u + 2*c`) &= \Pr(N(2) = 0) +  \Pr(N(2) = 1 \text{ and } X_1 = 50) \\ &+ 
  \Pr(N(2) = 1 \text{ and } X_1 = 70) +  \Pr(N(2) = 2 \text{ and } X_1 = X_2 = 50).\\
\end{aligned}
$$
Note that 
$$
\begin{aligned}
\Pr(N(2) = 0) &= `r pn0` \\
\Pr(N(2) = 1 \text{ and } X_1 = 50) &= \Pr(N(2) = 1) \cdot \Pr(X_1 = 50) = (`r pn1`)(`r px50`) = `r pn1*px50` \\
\Pr(N(2) = 1 \text{ and } X_1 = 75) &= \Pr(N(2) = 1) \cdot \Pr(X_1 = 75) = (`r pn1`)(`r px75`) = `r pn1*px75` \\
\Pr(N(2) = 2 \text{ and } X_1 = X_2 = 50) &= \Pr(N(2) = 2) \cdot \Pr(X_1 = 50) \cdot \Pr(X_2 = 50)= (`r pn2`)(`r px50`)^2 = `r pn2*px50*px50`
\end{aligned}
$$
Therefore, $\Pr(S(2) \le `r u + 2*c`) = `r pS2` and
$$\Pr(U(2) < 0) = \Pr(S(2) > `r u + 2*c`) = 1- \Pr(S(2) \le `r u + 2*c`) = 
1 - `r pS2` = `r 1-pS2`.$$



```{r echo = FALSE}
lambda <- 0.1

u <- 0.3
x <- c(1,2)
px <- c(0.7,0.3)

EX <- sum(x*px)

ES <- lambda*EX

c <- 0.4

#s0 <- u + 2*c # We require S(2) <= s0

t<-1
pn0 <- dpois(0,t*lambda)

noRuinProb = dpois(0,1.75*lambda)*( dpois(0,0.25*lambda) +  dpois(1,0.25*lambda)*px[which(x==1)])

```



3.

a) Ruin will occur in the first year if and only if a claim (of any amount) occurs. Therefore,
$$\psi(0.3,1) = 1 - \Pr(N(1) = 0) =  `r 1-pn0`.$$ 

b) In a two year time interval, **ruin will not occur** if and only if there are no claims before time 1.75 years (at which point the insurer's premium income plus initial surplus is equal to 1) AND there are no claims or at most one claim of amount 1 between the time interval 1.75 to 2.
$$
\begin{aligned}
1- \psi(0.3,1) &= \Pr(N(1.75) = 0) \cdot [ \Pr(N(2) - N(1.75) = 0  \text{ or } (N(2) - N(1.75) = 1 \text{ and } X_1 = 1) ]  \\
 &= \Pr(N(1.75) = 0) \cdot [ \Pr(N(2) - N(1.75) = 0)  + \Pr(N(2) - N(1.75) = 1 \text{ and } X_1 = 1) ]. 
\end{aligned}
$$
We have
$$
\begin{aligned}
\Pr(N(1.75) = 0) &= `r dpois(0,1.75*lambda) ` \\
\Pr(N(2) - N(1.75) = 0) &= `r dpois(0,0.25*lambda) ` \\
\Pr(N(2) - N(1.75) = 1 \text{ and } X_1 = 1) &= \Pr(N(2) - N(1.75) = 1) \cdot \Pr(X_1 = 1) = (`r dpois(1,0.25*lambda)`) \cdot (`r px[which(x==1)] `) =  `r dpois(1,0.25*lambda)*px[which(x==1)]`. 
\end{aligned}
$$

Therefore, 
$$1- \psi(0.3,1) = `r dpois(0,1.75*lambda) `\cdot (`r dpois(0,0.25*lambda) ` + `r dpois(1,0.25*lambda)*px[which(x==1)]`)  = `r noRuinProb`, $$
and
$$\psi(0.3,1) = `r 1 - noRuinProb`.$$ 




## Tutorial 8

1.  The table below gives the payments (in 000s THB) in cumulative form
    in successive development years in respect of a motor insurance
    portfolio. All claims are assumed to be fully settled by the end of
    development year 4. Use the chain ladder method to estimate the
    amount the insurer will pay in the calendar years
    $2018, 2019, 2020 ,2021$.

      ---------- ------ ------------------ ------ ------ ------ ------
                        Development year                        
                        0                  1      2      3      4
                  2013  750                768    844    929    1072
       Accident   2014  820                876    946    1041   
         Year     2015  960                997    1096          
                  2016  1040               1087                 
                  2017  1180                                    
      ---------- ------ ------------------ ------ ------ ------ ------

2.  The table below shows the claims payments (in 000s THB) in
    cumulative form for a portfolio of insurance policies. All claims
    are assumed to be fully settled by the end of development year 4 and
    the payments are made at the middle of each calendar year. The past
    rates of inflation over the 12 months up to the middle of the given
    year are as follows:

      ------ ----
       2014   5%
       2015   6%
       2016   7%
       2017   5%
      ------ ----

    The future rate of inflation from mid-2017 is assumed to be 10% per
    year.

      ---------- ------ ------------------ ------ ------ ------ ------
                        Development year                        
                        0                  1      2      3      4
                  2013  880                988    1046   1065   1262
       Accident   2014  940                1034   1091   1095   
         Year     2015  1060               1161   1229          
                  2016  1120               1221                 
                  2017  1240                                    
      ---------- ------ ------------------ ------ ------ ------ ------

    1.  Use the inflation-adjusted chain ladder method to calculate the
        outstanding claims payments in future years.

    2.  Using an interest rate of 7% per year, calculate the outstanding
        claims reserve the insurer should have hold on 1 January 2018.

3.  The table below shows the cumulative claims payments and the
    cumulative number of claims (amounts appear above claim numbers) for
    a portfolio of insurance policies. All claims are assumed to be
    fully settled by the end of development year 5 and that the effects
    of claims-cost inflation have been removed from these data. Use the
    average cost per claim method to estimate the outstanding claims
    reserve which should be held at the end of 2017.

      ---------- ------ ------------------ ------ ------ ------ ------ ------
                        Development year                               
                        0                  1      2      3      4      5
                  2012  2800               2954   3005   3275   3624   3895
                        420                440    453    493    551    591
                  2013  3200               3379   3449   3760   4184   
                        460                478    490    533    591    
       Accident   2014  3800               4004   4078   4454          
         Year           500                525    531    580           
                  2015  4520               4749   4842                 
                        520                549    558                  
                  2016  5340               5587                        
                        560                589                         
                  2017  5840                                           
                        570                                            
      ---------- ------ ------------------ ------ ------ ------ ------ ------

4.  The table below shows the cumulative claims payments and the premium
    income $P$ for a portfolio of insurance policies. All claims are
    assumed to be fully settled by the end of development year 4 and
    that the effects of claims-cost inflation have been removed from
    these data. Use the Bornhuetter-Ferguson method to estimate the
    total reserve required to meet the outstanding claims. You may
    assume that the ultimate loss ratio for accident years 2014-2017
    will be 95%.

      ---------- ------ ------------------ ------ ------ ------ ------ ------
                        Development year                               
                        0                  1      2      3      4      $P$
                  2013  3597               4226   4547   4807   4989   5937
       Accident   2014  4174               4697   5317   5497          6122
         Year     2015  4578               5082   5753                 6221
                  2016  4634               5343                        6365
                  2017  5203                                           6510
      ---------- ------ ------------------ ------ ------ ------ ------ ------


## Solutions to Tutorial 8

See the Excel solution file from the Google Classroom.

## Tutorial 9


1.  (Taken from Gray and Pitts) Suppose the number of claims which arise
    in a year on a group of policies is modelled as
    $X|\lambda \sim Poisson(\lambda)$ and that we observe a total of 14
    claims over a six year period. Suppose also we adopt a $\mathcal{G}(6, 3)$
    distribution as a prior distribution for $\lambda$.

    1.  State the maximum likelihood estimate of $\lambda$ and the prior
        mean.

    2.  State the posterior distribution of $\lambda$, find the mode of
        this distribution, and hence state the Bayesian estimate of
        $\lambda$ under all or nothing loss.

    3.  Note that if $Y \sim \mathcal{G}(\alpha,\beta)$ and $2\alpha$ is an
        integer, then $2\beta Y \sim \mathcal{G}(\alpha,1/2)$; that is
        $2\beta Y  \sim \chi^2$ with $2 \alpha$ degrees of freedom.

        1.  Using this fact, find the Bayesian estimate of $\lambda$
            under absolute error loss.

        2.  Find an equal-tailed 95% Bayesian interval estimate of
            $\lambda$, that is an interval $(\lambda_L, \lambda_U)$,
            such that
            $Pr( \lambda > \lambda_U | \underline{x}) = Pr( \lambda < \lambda_L | \underline{x}) = 0.025$.

    4.  Find the credibility estimate (the Bayesian estimate under
        squared-error loss) of $\lambda$.

2.  Recall that the data $x_1, x_2, \ldots, x_n$ are available on
    $X | \lambda$. Suppose we observe $\sum x_i = 13$ when $n = 50$.
    Based on the Poisson$-$Gamma model, the number of claims which arise
    in a year on a group of policies is modelled as
    $X|\lambda \sim Poisson(\lambda)$ and the prior distribution on the
    claim rate $\lambda$ is a $\mathcal{G}(\alpha,\beta)$ distribution.

    1.  Calculate the value of the maximum likelihood estimate of
        $\lambda$

    2.  Calculate the values of prior means and the prior variance in
        two cases (i) the prior is $\mathcal{G}(6,30)$ and (ii) the prior is
        $\mathcal{G}(2,10)$. Comment on the results.

    3.  For those two prior distributions, calculate the posterior mean
        of $\lambda$ given such data.

3.  Suppose the annual claims which arise under a risk, $X$, in units of
    1000THB, as $X | \theta \sim \mathcal{N}(\theta,0.36)$. From experience with
    other business, an insurer adopt a $\mathcal{N}(2, 0.04)$ prior for $\theta$.
    The insurer observe claim amounts for the past seven years :
    $2369, 2341, 2284, 2347, 2332, 2300, 2267$ THB. Using the
    normal$-$normal model:

    1.  Find the credibility factor and the credibility premium for the
        risk.

    2.  Find an equal-tailed 95% Bayesian interval estimate of $\theta$.

4.  Consider a collective of five separate risks from portfolios of
    general insurance policies, each of which has been in existence for
    at least ten years. The mean and variance of the aggregate claims
    adjusted for inflation over the past ten years are given in the
    table. Use EBCT Model 1 to calculate the credibility premiums for
    all five risks.

       Risk   Within risk mean   Within risk variance
      ------ ------------------ ----------------------
        1           138                  259
        2            98                  179
        3           120                  239
        4           104                  168
        5           119                  185

5.  Consider the aggregate claims in five successive years from
    comparable insurance policies (in units of 1000 THB).

    [\[TableRisks\]]{#TableRisks label="TableRisks"}

      ---------- --- ---------- ---- ---- ---- ----
                      Year $j$                 
                         1       2    3    4    5
       Risk $i$   1      68      65   77   76   74
                  2      54      59   56   50   62
                  3      81      95   83   82   89
                  4      64      70   77   66   73
      ---------- --- ---------- ---- ---- ---- ----

    1.  Use the EBCT Model 1 to calculate the credibility premium for
        each risk $i$.

    2.  Explain why the credibility premiums depend almost entirely on
        the means for the individual risks.




```{r tutorial9-1, echo=FALSE}

#likelihood
sumx <- 14
n <- 6
lambdahat <- sumx/n

#prio
alpha <- 6
beta <- 3
lambdatilde <- alpha/beta
```





## Solutions to Tutorial 9

1.

a) Based on the lecture note, the data consist of $n$ observations  $x_1, x_2, \ldots, x_n$ of random variables $X_1, \ldots , X_n$, where, given $\lambda$, the $X_i$ are iid Poisson random variables with parameter $\lambda$ for $i = 1,\ldots,n$. 

The likelihood is given by
$$ f(\underline{x}|\lambda) = \Pi_{i=1}^n  \frac{e^{-\lambda} \lambda^{x_i}}{x_i!} \propto e^{-n\lambda} \lambda^{\sum x_i}. $$
Therefore, the data-based estimator of $\lambda$  based on the maximum likelihood estimator is
$$\hat{\lambda} = \frac{\sum_i x_i}{n} = \frac{`r sumx`}{`r n`} = `r lambdahat`.$$


Without any data from the risk, a reasonable estimate value of $\lambda$ is the mean of the prior distribution with both parameters known and with density function 
$$ f(\lambda) = \frac{\beta^\alpha}{\Gamma(\alpha)} \lambda^{\alpha -1} e^{-\beta\lambda}, \quad \alpha >0, \, \beta >  0, \, \lambda > 0.$$
It follows that the estimate of $\lambda$ using the prior mean is
$$ \tilde{\lambda} = \frac{\alpha}{\beta} = \frac{`r alpha`}{`r beta`} = `r lambdatilde`.$$



b) The posterior density is proportional to 

$$ \begin{aligned}
f(\lambda| \underline{x}) &\propto (\lambda^{\alpha -1} e^{-\beta\lambda}) (e^{-n\lambda} \lambda^{\sum x_i}) \\
&= \lambda^{\alpha + \sum x_i -1} e^{-(\beta + n) \lambda} 
\end{aligned}
$$
This is the functional part of a gamma density. The posterior distribution is 
$$ \lambda | \underline{x} \sim \mathcal{G}(\alpha + \sum x_i, \beta + n) = \mathcal{G}(`r alpha + sumx`, `r beta + n`).$$

The Bayesian estimator of $\lambda$ under the all or nothing loss is the mode of the distribution, which is given by
$$\frac{`r alpha + sumx - 1`}{`r beta + n`} = `r (alpha + sumx - 1)/(beta + n)`.$$

c) Under absolute error loss, the median of$\mathcal{G}(`r alpha + sumx`, `r beta + n`)$ 
can be found by using the following R syntax 
$$\text{qgamma}(0.5, \text{shape}= `r alpha + sumx`, \text{rate}=`r beta + n`) = `r qgamma(0.5,shape=20,rate=9)`$$
Moreover, we can get
$$\lambda_L = \text{qgamma}(0.025, \text{shape}= `r alpha + sumx`, \text{rate}=`r beta + n`) = `r qgamma(0.025,shape=20,rate=9)`$$
and
$$\lambda_U = \text{qgamma}(0.975, \text{shape}= `r alpha + sumx`, \text{rate}=`r beta + n`) = `r qgamma(0.975,shape=20,rate=9)`.$$


d) The credibility estimate (i.e. the mean of $\mathcal{G}(`r alpha + sumx`, `r beta + n`)$) is

$$
\begin{aligned}
\lambda^* &= \frac{\alpha + \sum x_i}{ \beta + n} = \frac{`r alpha + sumx`}{`r beta + n`} = `r (alpha + sumx)/(beta + n)`.
\end{aligned},
$$
where $Z = n/(n+\beta)$. This can be expressed in the form of a credibility estimate.
\end{enumerate}



```{r tutorial9-2, echo=FALSE}
#likelihood
sumx <- 13
n <- 50
lambdahat <- sumx/n

#prio
alpha <- 6
beta <- 30
lambdatilde <- alpha/beta
priorvar <- alpha/beta^2

alpha2 <- 2
beta2 <- 10
lambdatilde2 <- alpha2/beta2
priorvar2 <- alpha2/beta2^2

Z <- n/(n + beta)
CP <- Z*lambdahat + (1 - Z)*lambdatilde

Z2 <- n/(n + beta2)
CP2 <- Z2*lambdahat + (1 - Z2)*lambdatilde2

```


2. From the Poisson-Gamma model, 

a) Therefore, the data-based estimator of $\lambda$  based on the maximum likelihood estimator is
$$\hat{\lambda} = \frac{\sum_i x_i}{n} = \frac{`r sumx`}{`r n`} = `r lambdahat`.$$
b) For $\lambda \sim \mathcal{G}(\alpha,\beta)$, we have
$$\text{E}[\lambda] = \frac{\alpha}{\beta} \text{ and } \text{Var}[\lambda] = \frac{\alpha}{\beta^2}.$$

i. For $\mathcal{G}(`r alpha`, `r beta`)$, the prior mean and prior variance are `r lambdatilde` and `r priorvar`, respectively.

ii. For $\mathcal{G}(`r alpha2`, `r beta2`)$, the prior mean and prior variance are `r lambdatilde2` and `r priorvar2`, respectively.

The variance of the prior distributions are `r priorvar` and `r priorvar2` in (i) and (ii), respectively. There is more uncertainty in  the prior distribution of (ii) which leads to the prior mean getting lower weight. Therefore, $Z$ should be larger in (ii).

c) The posterior mean of $\lambda$ (also denoted by CP) is

$$
\begin{aligned}
\text{CP}
&= (Z) \left( \frac{\sum x_i}{n} \right) +(1-Z) \left( \frac{\alpha}{\beta} \right)
\end{aligned},
$$
where $Z = n/(n+\beta)$. This can be expressed in the form of a credibility estimate.

i. In this case, $Z = \frac{`r n`}{`r n` + `r beta`} = `r Z`$ and $\text{CP} = `r CP`$.

ii. In this case, $Z = \frac{`r n`}{`r n` + `r beta2`} = `r Z2`$ and $\text{CP} = `r CP2`$.



```{r tutorial9.3, echo=FALSE}
x <- c(2369, 2341, 2284, 2347, 2332, 2300, 2267)
sumx <- sum(x)
n <- 7
sigma2 <- 0.36

mu0 <- 2000
sigma02 <- 0.04

Z <- n/(n + sigma2/sigma02)

CP <- Z*sumx/n + (1-Z)*mu0

#sigma*^2
sigmas2 <- sigma02*sigma2/(n*sigma02 + sigma2)

muL <- qnorm(0.025,CP/1000,sqrt(sigmas2))
  
muU <-  qnorm(0.975,CP/1000,sqrt(sigmas2)) 
```


3. 

a) We have $\sum_{i=1}^7 x_i = `r `sumx`$.
The credibility factor $Z$ is given by
$$ Z = \frac{n}{n + \frac{\sigma^2}{{\sigma_0^2}}} = `r Z`.$$
The credibility premium is
$$\text{CP} = Z\cdot\frac{\sum x_i}{n} + (1-Z)\cdot \mu_0 = `r CP`.$$

b) The posterior probability distribution function is $\mathcal{N}(\mu^*,\sigma^{*2})$, where (in unit of 1000)
$$\mu^* = `r CP/1000` \text{ and } \sigma^{*2} = \frac{\sigma_0^2\sigma^2}{n\sigma_0^2 + \sigma^2} = `r sigmas2`.$$
Therefore, using the following R commands, 
$$\mu_L = \text{qnorm}(0.025,`r CP/1000`,\sqrt{`r sigmas2`}) = `r muL`,$$
and
$$\mu_U = \text{qnorm}(0.975,`r CP/1000`,\sqrt{`r sigmas2`}) = `r muU`.$$


4. Not in the Final Examination.

5. Not in the Final Examination.